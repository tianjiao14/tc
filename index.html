<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½“æµ‹åˆ†æç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Microsoft YaHei', sans-serif; background-color: #f2f2f2; font-size: 13px; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å·¥å…·æ  */
        .toolbar { background: #217346; color: white; padding: 8px 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 8px; min-height: 50px; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 60; }
        .app-title { font-weight: bold; font-size: 1.2rem; margin-right: 15px; white-space: nowrap; }
        
        .btn { background: #f3f3f3; border: 1px solid #ccc; color: #333; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; white-space: nowrap; user-select: none; transition: all 0.1s; }
        .btn:active { background: #e0e0e0; transform: translateY(1px); }
        .btn-green { background: #4caf50; color: white; border: none; }
        .btn-red { background: #f44336; color: white; border: none; }
        .btn-blue { background: #2196f3; color: white; border: none; }

        .pagination { display: flex; align-items: center; gap: 5px; margin-left: auto; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px; }
        .page-info { font-size: 13px; color: #fff; font-weight: bold; font-family: monospace; min-width: 150px; text-align: center; }

        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ccc; padding-left: 10px; height: 40px; align-items: flex-end; flex-shrink: 0; }
        .tab { padding: 8px 25px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; color: #666; font-size: 14px; margin-right: 2px; }
        .tab.active { border-color: #ccc; border-bottom-color: #fff; background: #fff; color: #217346; font-weight: bold; margin-bottom: -1px; z-index: 5; }

        .excel-container { flex: 1; overflow: auto; background: white; border-top: 1px solid #d4d4d4; position: relative; }

        /* è¡¨æ ¼æ ·å¼ */
        table { 
            table-layout: fixed; 
            border-collapse: separate; 
            border-spacing: 0; 
            min-width: 100%; 
            white-space: nowrap; 
            border-left: 1px solid #a0a0a0; 
        }
        
        th, td { 
            border-right: 1px solid #a0a0a0; 
            border-bottom: 1px solid #a0a0a0; 
            padding: 0; 
            text-align: center; 
            height: 34px; 
            box-sizing: border-box; 
            overflow: hidden; 
        }

        /* è¡¨å¤´å›ºå®š */
        thead tr { position: sticky; top: 0; z-index: 40; }
        thead tr:first-child th { top: 0; z-index: 40; }
        thead tr:last-child th { top: 34px; z-index: 40; border-bottom: 3px solid #444 !important; }

        /* åˆ—å®½ */
        .col-class { width: 100px; min-width: 100px; }
        .col-name { width: 90px; min-width: 90px; }
        .col-std { width: 65px; min-width: 65px; }
        .col-w-xs { width: 45px; min-width: 45px; }
        
        /* è¾“å…¥æ¡† */
        input.cell-input { width: 100%; height: 100%; border: none; outline: none; text-align: center; background: transparent; font-family: inherit; font-size: 14px; color: #000; font-weight: 500; }
        input[disabled] { background-color: #f9f9f9; color: #ccc; cursor: not-allowed; }
        
        /* é€‰ä¸­è¡Œé«˜äº® */
        tbody tr:focus-within td { background-color: #fff9c4 !important; }

        /* é¢œè‰²ç±» */
        .bg-header-base { background-color: #ffffff; color: #000; font-weight: bold; }
        .bg-header-score { background-color: #ffff00; color: #000; font-weight: bold; }
        
        .text-exc { color: #008000; font-weight: bold; }
        .text-good { color: #0000ff; font-weight: bold; }
        .text-pass { color: #333; }
        .text-fail { color: #ff0000; font-weight: bold; background-color: #fff0f0; }
        
        .text-bmi-norm { color: #008000; font-weight: bold; }
        .text-bmi-warn { color: #ff9800; font-weight: bold; }
        .text-bmi-bad { color: #ff0000; font-weight: bold; background-color: #ffebee; }
        .text-total { color: #ff0000; font-weight: bold; font-size: 14px; text-decoration: underline; }
        .calc-cell { cursor: help; background-color: #fefefe; }

        /* æŠ¥è¡¨ */
        .hidden { display: none; }
        .report-section { padding: 15px; background: white; overflow: auto; flex: 1; }
        .report-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; font-size: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .report-table th, .report-table td { border: 1px solid #000; padding: 6px 4px; text-align: center; }
        .report-header-blue { background-color: #00b0f0; color: white; font-weight: bold; }
        .report-title { font-size: 16px; font-weight: bold; margin: 20px 0 10px; border-left: 6px solid #00b0f0; padding-left: 12px; color: #333; }

        @media (max-width: 640px) {
            .toolbar { justify-content: space-between; }
            .btn { flex-grow: 1; justify-content: center; padding: 8px; font-size: 12px;}
            .app-title { width: 100%; text-align: center; margin-bottom: 5px; margin-right: 0; }
            .pagination { width: 100%; justify-content: space-between; margin-top: 5px; order: 10; }
            #fileInput + button { width: 48%; } .btn-blue { width: 48%; }
        }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 bg-gray-800 flex items-center justify-center z-[100]">
        <div class="bg-white p-8 rounded-lg shadow-xl w-80 text-center">
            <h2 class="text-xl font-bold mb-4 text-gray-700">ğŸ”’ ç³»ç»Ÿé”å®š</h2>
            <p class="text-gray-500 text-sm mb-4">è¯·è¾“å…¥æˆæƒç ä»¥è®¿é—®æ•°æ®</p>
            <input type="password" id="passInput" class="w-full border border-gray-300 p-2 rounded mb-4 text-center text-lg outline-none focus:border-green-500" placeholder="æˆæƒç " autofocus>
            <button onclick="checkPass()" class="w-full bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700 transition">è§£é”ç³»ç»Ÿ</button>
            <p id="login-msg" class="text-red-500 text-xs mt-2 hidden">å¯†ç é”™è¯¯</p>
        </div>
    </div>

    <div id="app-content" class="hidden flex flex-col h-full overflow-hidden">
        <div class="toolbar">
            <span class="app-title">ğŸ“Š ä½“è´¨å¥åº·æµ‹è¯•</span>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
            <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å¯¼å…¥</button>
            <button class="btn" onclick="addNewRow()">â• è¡Œ</button>
            <button class="btn" onclick="exportToExcel()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
            <button class="btn btn-blue" onclick="exportAnalysisExcel()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
            <button class="btn btn-red" onclick="clearTable()">ğŸ—‘ï¸ æ¸…ç©º</button>
            
            <div class="pagination">
                <button class="btn" onclick="changeClass(-1)">â—€ ä¸Šä¸€ç­</button>
                <span id="page-info" class="page-info">æš‚æ— æ•°æ®</span>
                <button class="btn" onclick="changeClass(1)">ä¸‹ä¸€ç­ â–¶</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchView('data')" id="tab-data">æ•°æ®å½•å…¥</div>
            <div class="tab" onclick="switchView('report')" id="tab-report">åˆ†ææŠ¥å‘Š</div>
        </div>

        <div id="view-data" class="excel-container">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th rowspan="2" class="bg-header-base col-class">ç­çº§</th>
                        <th rowspan="2" class="bg-header-base col-name">å§“å</th>
                        <th rowspan="2" class="bg-header-base col-w-xs">æ€§åˆ«</th>
                        
                        <th rowspan="2" class="bg-header-base col-std">èº«é«˜<br>(cm)</th>
                        <th rowspan="2" class="bg-header-base col-std">ä½“é‡<br>(kg)</th>
                        <th rowspan="2" class="bg-header-base col-std">è‚ºæ´»é‡<br>(ml)</th>
                        <th rowspan="2" class="bg-header-base col-std">50ç±³è·‘<br>(s)</th>
                        <th rowspan="2" class="bg-header-base col-std">åä½<br>ä½“å‰å±ˆ</th>
                        <th rowspan="2" class="bg-header-base col-std">ä¸€åˆ†é’Ÿ<br>ä»°å§èµ·å</th>
                        <th rowspan="2" class="bg-header-base col-std">ç«‹å®š<br>è·³è¿œ</th>
                        <th rowspan="2" class="bg-header-base col-std">å¼•ä½“<br>å‘ä¸Š</th>
                        <th rowspan="2" class="bg-header-base col-std">1000ç±³è·‘</th>
                        <th rowspan="2" class="bg-header-base col-std">800ç±³è·‘</th>
                        
                        <th colspan="2" class="bg-header-score">BMI(15%)</th>
                        <th colspan="2" class="bg-header-score">è‚ºæ´»é‡(15%)</th>
                        <th colspan="2" class="bg-header-score">50ç±³è·‘(20%)</th>
                        <th colspan="2" class="bg-header-score">ç«‹å®šè·³è¿œ(10%)</th>
                        <th colspan="2" class="bg-header-score">åä½ä½“å‰å±ˆ(10%)</th>
                        <th colspan="2" class="bg-header-score">800ç±³è·‘(20%)</th>
                        <th colspan="2" class="bg-header-score">1000ç±³è·‘(20%)</th>
                        <th colspan="2" class="bg-header-score">ä»°å§èµ·å(10%)</th>
                        <th colspan="2" class="bg-header-score">å¼•ä½“å‘ä¸Š(10%)</th>
                        
                        <th rowspan="2" class="bg-header-score col-w-xs">é™„åŠ <br>åˆ†</th>
                        <th rowspan="2" class="bg-header-score col-std" style="color:red">æ€»åˆ†</th>
                        <th rowspan="2" class="bg-header-score col-std">ç­‰çº§</th>
                        <th rowspan="2" class="bg-header-base col-w-xs">åˆ </th>
                    </tr>
                    <tr id="subHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="view-report" class="report-section hidden">
            <div class="report-title">1. å…¨æ ¡æ•°æ®æ±‡æ€»</div><div id="report-overall" style="overflow-x:auto;"></div>
            <div class="report-title">2. å„é¡¹ç›®ä¼˜è‰¯ç‡ (ç”·å¥³åˆ†é¡¹)</div><div id="report-items" style="overflow-x:auto;"></div>
            <div class="report-title">3. ç­çº§è¯¦æƒ…åˆ†æ</div><div id="report-class" style="overflow-x:auto;"></div>
        </div>
    </div>

<script>
// --- å®‰å…¨é…ç½® ---
const AUTH_CONFIG = {
    code: "8888",       // æˆæƒç 
    sessionKey: "auth_passed_v1"
};

function checkPass() {
    const input = document.getElementById('passInput');
    const msg = document.getElementById('login-msg');
    const val = input.value.trim();

    if (val === AUTH_CONFIG.code) {
        unlockApp();
    } else {
        msg.classList.remove('hidden');
        input.value = '';
        input.focus();
        input.classList.add('border-red-500');
        setTimeout(() => input.classList.remove('border-red-500'), 200);
    }
}

function unlockApp() {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-content').classList.remove('hidden');
    sessionStorage.setItem(AUTH_CONFIG.sessionKey, 'true');
}

document.getElementById('passInput').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') checkPass();
});

// --- è‡ªåŠ¨ä¿å­˜é…ç½® ---
let GLOBAL_DATA = []; 
const STORAGE_KEY = 'TiCe_Data_v1';

function saveData() {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(GLOBAL_DATA));
    } catch (e) {
        console.error("å­˜å‚¨å¤±è´¥", e);
    }
}

function loadData() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) {
        try {
            GLOBAL_DATA = JSON.parse(raw);
            if (GLOBAL_DATA.length > 0) {
                updateUniqueClasses();
                CUR_CLASS_IDX = 0;
                renderTable();
                return true;
            }
        } catch (e) {
            GLOBAL_DATA = [];
        }
    }
    return false;
}

// --- æ ‡å‡†åº“åŠæ ¸å¿ƒé€»è¾‘ ---
let UNIQUE_CLASSES = []; 
let CUR_CLASS_IDX = 0;   

const STDS = {
    weights: { bmi:0.15, lung:0.15, run50:0.20, jump:0.10, sit:0.10, runL:0.20, str:0.10 },
    bmi: { "åˆä¸€ç”·": [15.4, 22.1, 24.9], "åˆä¸€å¥³": [14.7, 21.7, 24.4], "åˆäºŒç”·": [15.6, 22.5, 25.2], "åˆäºŒå¥³": [15.2, 22.2, 24.8], "åˆä¸‰ç”·": [15.7, 22.8, 26.0], "åˆä¸‰å¥³": [15.9, 22.6, 25.1], "é«˜ä¸€ç”·": [16.4, 23.2, 26.3], "é«˜ä¸€å¥³": [16.4, 22.7, 25.2], "é«˜äºŒç”·": [16.7, 23.7, 26.5], "é«˜äºŒå¥³": [16.8, 23.2, 25.4], "é«˜ä¸‰ç”·": [17.2, 23.8, 27.3], "é«˜ä¸‰å¥³": [17.0, 23.3, 25.7] },
    lung: { "åˆä¸€ç”·": [[3640,100],[3520,95],[3400,90],[3150,85],[2900,80],[2780,78],[2660,76],[2540,74],[2420,72],[2300,70],[2180,68],[2060,66],[1940,64],[1820,62],[1700,60],[1600,50],[1500,40],[1400,30],[1300,20],[1200,10]], "åˆäºŒç”·": [[3940,100],[3820,95],[3700,90],[3450,85],[3200,80],[3080,78],[2960,76],[2840,74],[2720,72],[2600,70],[2480,68],[2360,66],[2240,64],[2120,62],[2000,60],[1890,50],[1780,40],[1670,30],[1560,20],[1450,10]], "åˆä¸‰ç”·": [[4240,100],[4120,95],[4000,90],[3750,85],[3500,80],[3380,78],[3260,76],[3140,74],[3020,72],[2900,70],[2780,68],[2660,66],[2540,64],[2420,62],[2300,60],[2180,50],[2060,40],[1940,30],[1820,20],[1700,10]], "é«˜ä¸€ç”·": [[4540,100],[4420,95],[4300,90],[4050,85],[3800,80],[3680,78],[3560,76],[3440,74],[3320,72],[3200,70],[3080,68],[2960,66],[2840,64],[2720,62],[2600,60],[2470,50],[2340,40],[2210,30],[2080,20],[1950,10]], "é«˜äºŒç”·": [[4740,100],[4620,95],[4500,90],[4250,85],[4000,80],[3880,78],[3760,76],[3640,74],[3520,72],[3400,70],[3280,68],[3160,66],[3040,64],[2920,62],[2800,60],[2660,50],[2520,40],[2380,30],[2240,20],[2100,10]], "é«˜ä¸‰ç”·": [[4940,100],[4820,95],[4700,90],[4450,85],[4200,80],[4080,78],[3960,76],[3840,74],[3720,72],[3600,70],[3480,68],[3360,66],[3240,64],[3120,62],[3000,60],[2850,50],[2700,40],[2550,30],[2400,20],[2250,10]], "åˆä¸€å¥³": [[2750,100],[2650,95],[2550,90],[2450,85],[2350,80],[2250,78],[2150,76],[2050,74],[1950,72],[1850,70],[1750,68],[1650,66],[1550,64],[1450,62],[1350,60],[1310,50],[1270,40],[1230,30],[1190,20],[1150,10]], "åˆäºŒå¥³": [[2900,100],[2850,95],[2800,90],[2650,85],[2500,80],[2400,78],[2300,76],[2200,74],[2100,72],[2000,70],[1900,68],[1800,66],[1700,64],[1600,62],[1500,60],[1460,50],[1420,40],[1380,30],[1340,20],[1300,10]], "åˆä¸‰å¥³": [[3050,100],[3000,95],[2950,90],[2800,85],[2650,80],[2550,78],[2450,76],[2350,74],[2250,72],[2150,70],[2050,68],[1950,66],[1850,64],[1750,62],[1650,60],[1610,50],[1570,40],[1530,30],[1490,20],[1450,10]], "é«˜ä¸€å¥³": [[3150,100],[3100,95],[3050,90],[2900,85],[2750,80],[2650,78],[2550,76],[2450,74],[2350,72],[2250,70],[2150,68],[2050,66],[1950,64],[1850,62],[1750,60],[1710,50],[1670,40],[1630,30],[1590,20],[1550,10]], "é«˜äºŒå¥³": [[3250,100],[3200,95],[3150,90],[3000,85],[2850,80],[2750,78],[2650,76],[2550,74],[2450,72],[2350,70],[2250,68],[2150,66],[2050,64],[1950,62],[1850,60],[1810,50],[1770,40],[1730,30],[1690,20],[1650,10]], "é«˜ä¸‰å¥³": [[3350,100],[3300,95],[3250,90],[3100,85],[2950,80],[2850,78],[2750,76],[2650,74],[2550,72],[2450,70],[2350,68],[2250,66],[2150,64],[2050,62],[1950,60],[1910,50],[1870,40],[1830,30],[1790,20],[1750,10]] },
    run50: { "åˆä¸€ç”·": [[7.8,100],[7.9,95],[8,90],[8.1,85],[8.2,80],[8.4,78],[8.6,76],[8.8,74],[9,72],[9.2,70],[9.4,68],[9.6,66],[9.8,64],[10,62],[10.2,60],[10.4,50],[10.6,40],[10.8,30],[11,20],[11.2,10]], "åˆäºŒç”·": [[7.5,100],[7.6,95],[7.7,90],[7.8,85],[7.9,80],[8.1,78],[8.3,76],[8.5,74],[8.7,72],[8.9,70],[9.1,68],[9.3,66],[9.5,64],[9.7,62],[9.9,60],[10.1,50],[10.3,40],[10.5,30],[10.7,20],[10.9,10]], "åˆä¸‰ç”·": [[7.3,100],[7.4,95],[7.5,90],[7.6,85],[7.7,80],[7.9,78],[8.1,76],[8.3,74],[8.5,72],[8.7,70],[8.9,68],[9.1,66],[9.3,64],[9.5,62],[9.7,60],[9.9,50],[10.1,40],[10.3,30],[10.5,20],[10.7,10]], "é«˜ä¸€ç”·": [[7.1,100],[7.2,95],[7.3,90],[7.4,85],[7.5,80],[7.7,78],[7.9,76],[8.1,74],[8.3,72],[8.5,70],[8.7,68],[8.9,66],[9.1,64],[9.3,62],[9.5,60],[9.7,50],[9.9,40],[10.1,30],[10.3,20],[10.5,10]], "é«˜äºŒç”·": [[7,100],[7.1,95],[7.2,90],[7.3,85],[7.4,80],[7.6,78],[7.8,76],[8,74],[8.2,72],[8.4,70],[8.6,68],[8.8,66],[9,64],[9.2,62],[9.4,60],[9.6,50],[9.8,40],[10,30],[10.2,20],[10.4,10]], "é«˜ä¸‰ç”·": [[6.8,100],[6.9,95],[7,90],[7.1,85],[7.2,80],[7.4,78],[7.6,76],[7.8,74],[8,72],[8.2,70],[8.4,68],[8.6,66],[8.8,64],[9,62],[9.2,60],[9.4,50],[9.6,40],[9.8,30],[10,20],[10.2,10]], "åˆä¸€å¥³": [[8.1,100],[8.2,95],[8.3,90],[8.6,85],[8.9,80],[9.1,78],[9.3,76],[9.5,74],[9.7,72],[9.9,70],[10.1,68],[10.3,66],[10.5,64],[10.7,62],[10.9,60],[11.1,50],[11.3,40],[11.5,30],[11.7,20],[11.9,10]], "åˆäºŒå¥³": [[8,100],[8.1,95],[8.2,90],[8.5,85],[8.8,80],[9,78],[9.2,76],[9.4,74],[9.6,72],[9.8,70],[10,68],[10.2,66],[10.4,64],[10.6,62],[10.8,60],[11,50],[11.2,40],[11.4,30],[11.6,20],[11.8,10]], "åˆä¸‰å¥³": [[7.9,100],[8,95],[8.1,90],[8.4,85],[8.7,80],[8.9,78],[9.1,76],[9.3,74],[9.5,72],[9.7,70],[9.9,68],[10.1,66],[10.3,64],[10.5,62],[10.7,60],[10.9,50],[11.1,40],[11.3,30],[11.5,20],[11.7,10]], "é«˜ä¸€å¥³": [[7.8,100],[7.9,95],[8,90],[8.3,85],[8.6,80],[8.8,78],[9,76],[9.2,74],[9.4,72],[9.6,70],[9.8,68],[10,66],[10.2,64],[10.4,62],[10.6,60],[10.8,50],[11,40],[11.2,30],[11.4,20],[11.6,10]], "é«˜äºŒå¥³": [[7.7,100],[7.8,95],[7.9,90],[8.2,85],[8.5,80],[8.7,78],[8.9,76],[9.1,74],[9.3,72],[9.5,70],[9.7,68],[9.9,66],[10.1,64],[10.3,62],[10.5,60],[10.7,50],[10.9,40],[11.1,30],[11.3,20],[11.5,10]], "é«˜ä¸‰å¥³": [[7.6,100],[7.7,95],[7.8,90],[8.1,85],[8.4,80],[8.6,78],[8.8,76],[9,74],[9.2,72],[9.4,70],[9.6,68],[9.8,66],[10,64],[10.2,62],[10.4,60],[10.6,50],[10.8,40],[11,30],[11.2,20],[11.4,10]] },
    sit: { "åˆä¸€ç”·": [[17.6,100],[15.9,95],[14.2,90],[12.3,85],[10.4,80],[9.1,78],[7.8,76],[6.5,74],[5.2,72],[3.9,70],[2.6,68],[1.3,66],[0,64],[-1.3,62],[-2.6,60],[-3.8,50],[-5,40],[-6.2,30],[-7.4,20],[-8.6,10]], "åˆäºŒç”·": [[19.6,100],[17.7,95],[15.8,90],[13.7,85],[11.6,80],[10.3,78],[9,76],[7.7,74],[6.4,72],[5.1,70],[3.8,68],[2.5,66],[1.2,64],[-0.1,62],[-1.4,60],[-2.6,50],[-3.8,40],[-5,30],[-6.2,20],[-7.4,10]], "åˆä¸‰ç”·": [[21.6,100],[19.7,95],[17.8,90],[15.8,85],[13.8,80],[12.4,78],[11,76],[9.6,74],[8.2,72],[6.8,70],[5.4,68],[4,66],[2.6,64],[1.2,62],[-0.2,60],[-1.4,50],[-2.6,40],[-3.8,30],[-5,20],[-6.2,10]], "é«˜ä¸€ç”·": [[23.6,100],[21.5,95],[19.4,90],[17.2,85],[15,80],[13.6,78],[12.2,76],[10.8,74],[9.4,72],[8,70],[6.6,68],[5.2,66],[3.8,64],[2.4,62],[1,60],[0,50],[-1,40],[-2,30],[-3,20],[-4,10]], "é«˜äºŒç”·": [[24.3,100],[22.4,95],[20.5,90],[18.3,85],[16.1,80],[14.7,78],[13.3,76],[11.9,74],[10.5,72],[9.1,70],[7.7,68],[6.3,66],[4.9,64],[3.5,62],[2.1,60],[1.1,50],[0.1,40],[-0.9,30],[-1.9,20],[-2.9,10]], "é«˜ä¸‰ç”·": [[24.6,100],[22.8,95],[21,90],[19.1,85],[17.2,80],[15.8,78],[14.4,76],[13,74],[11.6,72],[10.2,70],[8.8,68],[7.4,66],[6,64],[4.6,62],[3.2,60],[2.2,50],[1.2,40],[0.2,30],[-0.8,20],[-1.8,10]], "åˆä¸€å¥³": [[21.8,100],[20.1,95],[18.4,90],[16.7,85],[15,80],[13.7,78],[12.4,76],[11.1,74],[9.8,72],[8.5,70],[7.2,68],[5.9,66],[4.6,64],[3.3,62],[2,60],[1.2,50],[0.4,40],[-0.4,30],[-1.2,20],[-2,10]], "åˆäºŒå¥³": [[22.7,100],[21,95],[19.3,90],[17.6,85],[15.9,80],[14.6,78],[13.3,76],[12,74],[10.7,72],[9.4,70],[8.1,68],[6.8,66],[5.5,64],[4.2,62],[2.9,60],[2.1,50],[1.3,40],[0.5,30],[-0.3,20],[-1.1,10]], "åˆä¸‰å¥³": [[23.5,100],[21.8,95],[20.1,90],[18.4,85],[16.7,80],[15.4,78],[14.1,76],[12.8,74],[11.5,72],[10.2,70],[8.9,68],[7.6,66],[6.3,64],[5,62],[3.7,60],[2.9,50],[2.1,40],[1.3,30],[0.5,20],[-0.3,10]], "é«˜ä¸€å¥³": [[24.2,100],[22.5,95],[20.8,90],[19.1,85],[17.4,80],[16.1,78],[14.8,76],[13.5,74],[12.2,72],[10.9,70],[9.6,68],[8.3,66],[7,64],[5.7,62],[4.4,60],[3.6,50],[2.8,40],[2,30],[1.2,20],[0.4,10]], "é«˜äºŒå¥³": [[24.8,100],[23.1,95],[21.4,90],[19.7,85],[18,80],[16.7,78],[15.4,76],[14.1,74],[12.8,72],[11.5,70],[10.2,68],[8.9,66],[7.6,64],[6.3,62],[5,60],[4.2,50],[3.4,40],[2.6,30],[1.8,20],[1,10]], "é«˜ä¸‰å¥³": [[25.3,100],[23.6,95],[21.9,90],[20.2,85],[18.5,80],[17.2,78],[15.9,76],[14.6,74],[13.3,72],[12,70],[10.7,68],[9.4,66],[8.1,64],[6.8,62],[5.5,60],[4.7,50],[3.9,40],[3.1,30],[2.3,20],[1.5,10]] },
    jump: { "åˆä¸€ç”·": [[225,100],[218,95],[211,90],[203,85],[195,80],[191,78],[187,76],[183,74],[179,72],[175,70],[171,68],[167,66],[163,64],[159,62],[155,60],[150,50],[145,40],[140,30],[135,20],[130,10]], "åˆäºŒç”·": [[240,100],[233,95],[226,90],[218,85],[210,80],[206,78],[202,76],[198,74],[194,72],[190,70],[186,68],[182,66],[178,64],[174,62],[170,60],[165,50],[160,40],[155,30],[150,20],[145,10]], "åˆä¸‰ç”·": [[250,100],[245,95],[240,90],[233,85],[225,80],[221,78],[217,76],[213,74],[209,72],[205,70],[201,68],[197,66],[193,64],[189,62],[185,60],[180,50],[175,40],[170,30],[165,20],[160,10]], "é«˜ä¸€ç”·": [[260,100],[255,95],[250,90],[243,85],[235,80],[231,78],[227,76],[223,74],[219,72],[215,70],[211,68],[207,66],[203,64],[199,62],[195,60],[190,50],[185,40],[180,30],[175,20],[170,10]], "é«˜äºŒç”·": [[265,100],[260,95],[255,90],[248,85],[240,80],[236,78],[232,76],[228,74],[224,72],[220,70],[216,68],[212,66],[208,64],[204,62],[200,60],[195,50],[190,40],[185,30],[180,20],[175,10]], "é«˜ä¸‰ç”·": [[270,100],[265,95],[260,90],[253,85],[245,80],[241,78],[237,76],[233,74],[229,72],[225,70],[221,68],[217,66],[213,64],[209,62],[205,60],[200,50],[195,40],[190,30],[185,20],[180,10]], "åˆä¸€å¥³": [[196,100],[190,95],[184,90],[177,85],[170,80],[167,78],[164,76],[161,74],[158,72],[155,70],[152,68],[149,66],[146,64],[143,62],[140,60],[135,50],[130,40],[125,30],[120,20],[115,10]], "åˆäºŒå¥³": [[200,100],[194,95],[188,90],[181,85],[174,80],[171,78],[168,76],[165,74],[162,72],[159,70],[156,68],[153,66],[150,64],[147,62],[144,60],[139,50],[134,40],[129,30],[124,20],[119,10]], "åˆä¸‰å¥³": [[202,100],[196,95],[190,90],[183,85],[176,80],[173,78],[170,76],[167,74],[164,72],[161,70],[158,68],[155,66],[152,64],[149,62],[146,60],[141,50],[136,40],[131,30],[126,20],[121,10]], "é«˜ä¸€å¥³": [[204,100],[198,95],[192,90],[185,85],[178,80],[175,78],[172,76],[169,74],[166,72],[163,70],[160,68],[157,66],[154,64],[151,62],[148,60],[143,50],[138,40],[133,30],[128,20],[123,10]], "é«˜äºŒå¥³": [[205,100],[199,95],[193,90],[186,85],[179,80],[176,78],[173,76],[170,74],[167,72],[164,70],[161,68],[158,66],[155,64],[152,62],[149,60],[144,50],[139,40],[134,30],[129,20],[124,10]], "é«˜ä¸‰å¥³": [[206,100],[200,95],[194,90],[187,85],[180,80],[177,78],[174,76],[171,74],[168,72],[165,70],[162,68],[159,66],[156,64],[153,62],[150,60],[145,50],[140,40],[135,30],[130,20],[125,10]] },
    str: { "åˆä¸€ç”·": [[13,100],[12,95],[11,90],[10,85],[9,80],[8,76],[7,72],[6,68],[5,64],[4,60],[3,50],[2,40],[1,30]], "åˆäºŒç”·": [[14,100],[13,95],[12,90],[11,85],[10,80],[9,76],[8,72],[7,68],[6,64],[5,60],[4,50],[3,40],[2,30],[1,20]], "åˆä¸‰ç”·": [[15,100],[14,95],[13,90],[12,85],[11,80],[10,76],[9,72],[8,68],[7,64],[6,60],[5,50],[4,40],[3,30],[2,20],[1,10]], "é«˜ä¸€ç”·": [[16,100],[15,95],[14,90],[13,85],[12,80],[11,76],[10,72],[9,68],[8,64],[7,60],[6,50],[5,40],[4,30],[3,20],[2,10]], "é«˜äºŒç”·": [[17,100],[16,95],[15,90],[14,85],[13,80],[12,76],[11,72],[10,68],[9,64],[8,60],[7,50],[6,40],[5,30],[4,20],[3,10]], "é«˜ä¸‰ç”·": [[18,100],[17,95],[16,90],[15,85],[14,80],[13,76],[12,72],[11,68],[10,64],[9,60],[8,50],[7,40],[6,30],[5,20],[4,10]], "åˆä¸€å¥³": [[50,100],[48,95],[46,90],[43,85],[40,80],[38,78],[36,76],[34,74],[32,72],[30,70],[28,68],[26,66],[24,64],[22,62],[20,60],[18,50],[16,40],[14,30],[12,20],[10,10]], "åˆäºŒå¥³": [[51,100],[49,95],[47,90],[44,85],[41,80],[39,78],[37,76],[35,74],[33,72],[31,70],[29,68],[27,66],[25,64],[23,62],[21,60],[19,50],[17,40],[15,30],[13,20],[11,10]], "åˆä¸‰å¥³": [[52,100],[50,95],[48,90],[45,85],[42,80],[40,78],[38,76],[36,74],[34,72],[32,70],[30,68],[28,66],[26,64],[24,62],[22,60],[20,50],[18,40],[16,30],[14,20],[12,10]], "é«˜ä¸€å¥³": [[53,100],[51,95],[49,90],[46,85],[43,80],[41,78],[39,76],[37,74],[35,72],[33,70],[31,68],[29,66],[27,64],[25,62],[23,60],[21,50],[19,40],[17,30],[15,20],[13,10]], "é«˜äºŒå¥³": [[54,100],[52,95],[50,90],[47,85],[44,80],[42,78],[40,76],[38,74],[36,72],[34,70],[32,68],[30,66],[28,64],[26,62],[24,60],[22,50],[20,40],[18,30],[16,20],[14,10]], "é«˜ä¸‰å¥³": [[55,100],[53,95],[51,90],[48,85],[45,80],[43,78],[41,76],[39,74],[37,72],[35,70],[33,68],[31,66],[29,64],[27,62],[25,60],[23,50],[21,40],[19,30],[17,20],[15,10]] },
    runL: { "åˆä¸€ç”·": [[235,100],[245,95],[255,90],[262,85],[270,80],[275,78],[280,76],[285,74],[290,72],[295,70],[300,68],[305,66],[310,64],[315,62],[320,60],[340,50],[360,40],[380,30],[400,20],[420,10]], "åˆäºŒç”·": [[230,100],[235,95],[240,90],[247,85],[255,80],[260,78],[265,76],[270,74],[275,72],[280,70],[285,68],[290,66],[295,64],[300,62],[305,60],[325,50],[345,40],[365,30],[385,20],[405,10]], "åˆä¸‰ç”·": [[220,100],[225,95],[230,90],[237,85],[245,80],[250,78],[255,76],[260,74],[265,72],[270,70],[275,68],[280,66],[285,64],[290,62],[295,60],[315,50],[335,40],[355,30],[375,20],[395,10]], "é«˜ä¸€ç”·": [[210,100],[215,95],[220,90],[227,85],[235,80],[240,78],[245,76],[250,74],[255,72],[260,70],[265,68],[270,66],[275,64],[280,62],[285,60],[305,50],[325,40],[345,30],[365,20],[385,10]], "é«˜äºŒç”·": [[205,100],[210,95],[215,90],[222,85],[230,80],[235,78],[240,76],[245,74],[250,72],[255,70],[260,68],[265,66],[270,64],[275,62],[280,60],[300,50],[320,40],[340,30],[360,20],[380,10]], "é«˜ä¸‰ç”·": [[200,100],[205,95],[210,90],[217,85],[225,80],[230,78],[235,76],[240,74],[245,72],[250,70],[255,68],[260,66],[265,64],[270,62],[275,60],[295,50],[315,40],[335,30],[355,20],[375,10]], "åˆä¸€å¥³": [[215,100],[222,95],[229,90],[237,85],[245,80],[250,78],[255,76],[260,74],[265,72],[270,70],[275,68],[280,66],[285,64],[290,62],[295,60],[305,50],[315,40],[325,30],[335,20],[345,10]], "åˆäºŒå¥³": [[210,100],[217,95],[224,90],[232,85],[240,80],[245,78],[250,76],[255,74],[260,72],[265,70],[270,68],[275,66],[280,64],[285,62],[290,60],[300,50],[310,40],[320,30],[330,20],[340,10]], "åˆä¸‰å¥³": [[205,100],[212,95],[219,90],[227,85],[235,80],[240,78],[245,76],[250,74],[255,72],[260,70],[265,68],[270,66],[275,64],[280,62],[285,60],[295,50],[305,40],[315,30],[325,20],[335,10]], "é«˜ä¸€å¥³": [[204,100],[210,95],[216,90],[223,85],[230,80],[235,78],[240,76],[245,74],[250,72],[255,70],[260,68],[265,66],[270,64],[275,62],[280,60],[290,50],[300,40],[310,30],[320,20],[330,10]], "é«˜äºŒå¥³": [[202,100],[208,95],[214,90],[221,85],[228,80],[233,78],[238,76],[243,74],[248,72],[253,70],[258,68],[263,66],[268,64],[273,62],[278,60],[288,50],[298,40],[308,30],[318,20],[328,10]], "é«˜ä¸‰å¥³": [[200,100],[206,95],[212,90],[219,85],[226,80],[231,78],[236,76],[241,74],[246,72],[251,70],[256,68],[261,66],[266,64],[271,62],[276,60],[286,50],[296,40],[306,30],[316,20],[326,10]] },
    bonusRule: {
        run: { "ç”·": {base: 4, limit: 20}, "å¥³": {base: 5, limit: 20} },
        str: { "ç”·": {base: 1, limit: 20}, "å¥³": {base: 1, limit: 20} }
    }
};

function getSafeKey(grade, gender) {
    const k = grade + gender;
    if (STDS.lung[k]) return k;
    return null; 
}

function normalizeGrade(str) {
    if(!str) return ''; 
    const s = String(str);
    if(s.includes('é«˜ä¸‰')||s.includes('12')) return 'é«˜ä¸‰';
    if(s.includes('é«˜äºŒ')||s.includes('11')) return 'é«˜äºŒ';
    if(s.includes('é«˜ä¸€')||s.includes('10')) return 'é«˜ä¸€';
    if(s.includes('åˆä¸‰')||s.includes('9')) return 'åˆä¸‰';
    if(s.includes('åˆäºŒ')||s.includes('8')) return 'åˆäºŒ';
    if(s.includes('åˆä¸€')||s.includes('7')) return 'åˆä¸€';
    return ''; 
}

function normalizeGender(v) {
    v = String(v).trim();
    if(v === '2' || v.includes('å¥³')) return 'å¥³';
    if(v === '1' || v.includes('ç”·')) return 'ç”·';
    return ''; 
}

function parseTime(v) {
    if(!v) return 0;
    if(v < 10) { 
        const m = Math.floor(v);
        const s = Math.round((v-m)*100);
        return m*60 + s;
    }
    return v; 
}

function getAnalysisData() {
    const stats = { 'å…¨æ ¡': {tot:0,exc:0,good:0,pass:0,fail:0} };
    const itemStats = {}; const classStats = {};
    const existGrades = new Set();

    GLOBAL_DATA.forEach(d => { if (!d.res.err && d.grade) existGrades.add(d.grade); });
    existGrades.forEach(g => {
        stats[g] = {tot:0,exc:0,good:0,pass:0,fail:0};
        itemStats[g] = { 
            lungM:{c:0,t:0}, lungF:{c:0,t:0}, r50M:{c:0,t:0}, r50F:{c:0,t:0}, 
            jumpM:{c:0,t:0}, jumpF:{c:0,t:0}, sitM:{c:0,t:0}, sitF:{c:0,t:0}, 
            runM:{c:0,t:0}, runF:{c:0,t:0}, strM:{c:0,t:0}, strF:{c:0,t:0}
        };
    });

    GLOBAL_DATA.forEach(d => {
        if (d.res.err) return;
        const cls = d.gc || 'æœªçŸ¥';
        const grade = d.grade;
        const suffix = d.isMale ? 'M' : 'F';
        
        if(!classStats[cls]) classStats[cls] = {tot:0,exc:0,good:0,pass:0,fail:0};

        const add = (o) => {
            o.tot++;
            if(d.res.total>=90) o.exc++;
            else if(d.res.total>=80) o.good++;
            else if(d.res.total>=60) o.pass++;
            else o.fail++;
        };

        add(stats['å…¨æ ¡']);
        if(stats[grade]) add(stats[grade]);
        add(classStats[cls]);

        const chk = (k, s) => { if(s!==null && s!=='-' && s!==0 && !isNaN(s)) { itemStats[grade][k].t++; if(s>=80) itemStats[grade][k].c++; } };
        if(itemStats[grade]) {
            chk('lung'+suffix, d.res.sLung); 
            chk('r50'+suffix, d.res.s50); 
            chk('jump'+suffix, d.res.sJump);
            chk('sit'+suffix, d.res.sSit); 
            chk('run'+suffix, d.res.sRun); 
            chk('str'+suffix, d.res.sStr);
        }
    });
    return { stats, itemStats, classStats, existGrades };
}

function genReport() {
    const { stats, itemStats, classStats, existGrades } = getAnalysisData();
    const pct = (n,t) => t ? ((n/t)*100).toFixed(1)+'%' : '0%';
    const fmt = (n,t) => `${n} (${pct(n,t)})`;

    // 1. å…¨æ ¡æ±‡æ€»
    let h1 = `<table class="report-table"><tr class="report-header-blue"><th>å¯¹è±¡</th><th>æ€»æ•°</th><th>ä¼˜ç§€</th><th>ä¼˜è‰¯</th><th>åŠæ ¼</th><th>ä¸åŠæ ¼</th></tr>`;
    ['å…¨æ ¡', ...Array.from(existGrades).sort()].forEach(k => {
        const s = stats[k];
        h1 += `<tr><td>${k}</td><td>${s.tot}</td><td>${fmt(s.exc,s.tot)}</td><td>${fmt(s.exc+s.good,s.tot)}</td><td>${fmt(s.tot-s.fail,s.tot)}</td><td class="text-fail">${fmt(s.fail,s.tot)}</td></tr>`;
    });
    h1 += '</table>';
    document.getElementById('report-overall').innerHTML = h1;

    // 2. åˆ†é¡¹ä¼˜è‰¯ç‡
    let h2 = `<table class="report-table"><tr class="report-header-blue">
        <th>å¹´çº§</th>
        <th>è‚ºæ´»é‡(ç”·)</th><th>è‚ºæ´»é‡(å¥³)</th>
        <th>50ç±³(ç”·)</th><th>50ç±³(å¥³)</th>
        <th>ç«‹å®šè·³è¿œ(ç”·)</th><th>ç«‹å®šè·³è¿œ(å¥³)</th>
        <th>åä½ä½“å‰å±ˆ(ç”·)</th><th>åä½ä½“å‰å±ˆ(å¥³)</th>
        <th>1000ç±³</th><th>800ç±³</th>
        <th>å¼•ä½“å‘ä¸Š</th><th>ä»°å§èµ·å</th>
    </tr>`;
    Array.from(existGrades).sort().forEach(g => {
        const i = itemStats[g];
        h2 += `<tr><td>${g}</td>
            <td>${fmt(i.lungM.c,i.lungM.t)}</td><td>${fmt(i.lungF.c,i.lungF.t)}</td>
            <td>${fmt(i.r50M.c,i.r50M.t)}</td><td>${fmt(i.r50F.c,i.r50F.t)}</td>
            <td>${fmt(i.jumpM.c,i.jumpM.t)}</td><td>${fmt(i.jumpF.c,i.jumpF.t)}</td>
            <td>${fmt(i.sitM.c,i.sitM.t)}</td><td>${fmt(i.sitF.c,i.sitF.t)}</td>
            <td>${fmt(i.runM.c,i.runM.t)}</td><td>${fmt(i.runF.c,i.runF.t)}</td>
            <td>${fmt(i.strM.c,i.strM.t)}</td><td>${fmt(i.strF.c,i.strF.t)}</td>
        </tr>`;
    });
    h2 += '</table>';
    document.getElementById('report-items').innerHTML = h2;

    // 3. ç­çº§è¯¦æƒ…
    let h3 = `<table class="report-table"><tr class="report-header-blue"><th>ç­çº§</th><th>æ€»æ•°</th><th>ä¼˜è‰¯ç‡</th><th>åŠæ ¼ç‡</th><th>ä¸åŠæ ¼</th></tr>`;
    Object.keys(classStats).sort().forEach(c => {
        const s = classStats[c];
        h3 += `<tr><td>${c}</td><td>${s.tot}</td><td>${fmt(s.exc+s.good,s.tot)}</td><td>${fmt(s.tot-s.fail,s.tot)}</td><td class="${s.fail>0?'text-fail':''}">${fmt(s.fail,s.tot)}</td></tr>`;
    });
    h3 += '</table>';
    document.getElementById('report-class').innerHTML = h3;
}

function exportAnalysisExcel() {
    const { stats, itemStats, classStats, existGrades } = getAnalysisData();
    const wb = XLSX.utils.book_new();
    const pct = (n,t) => t ? ((n/t)*100).toFixed(1)+'%' : '0%';
    const fmt = (n,t) => `${n} (${pct(n,t)})`;

    // Sheet 1
    const s1 = [['å¯¹è±¡','æ€»æ•°','ä¼˜ç§€','ä¼˜è‰¯','åŠæ ¼','ä¸åŠæ ¼']];
    ['å…¨æ ¡', ...Array.from(existGrades).sort()].forEach(k => {
        const s = stats[k];
        s1.push([k, s.tot, fmt(s.exc,s.tot), fmt(s.exc+s.good,s.tot), fmt(s.tot-s.fail,s.tot), fmt(s.fail,s.tot)]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s1), "å…¨æ ¡æ±‡æ€»");

    // Sheet 2
    const s2 = [['å¹´çº§','è‚ºæ´»é‡(ç”·)','è‚ºæ´»é‡(å¥³)','50ç±³(ç”·)','50ç±³(å¥³)','è·³è¿œ(ç”·)','è·³è¿œ(å¥³)','åä½(ç”·)','åä½(å¥³)','1000ç±³','800ç±³','å¼•ä½“','ä»°å§']];
    Array.from(existGrades).sort().forEach(g => {
        const i = itemStats[g];
        s2.push([g, 
            fmt(i.lungM.c,i.lungM.t), fmt(i.lungF.c,i.lungF.t),
            fmt(i.r50M.c,i.r50M.t), fmt(i.r50F.c,i.r50F.t),
            fmt(i.jumpM.c,i.jumpM.t), fmt(i.jumpF.c,i.jumpF.t),
            fmt(i.sitM.c,i.sitM.t), fmt(i.sitF.c,i.sitF.t),
            fmt(i.runM.c,i.runM.t), fmt(i.runF.c,i.runF.t),
            fmt(i.strM.c,i.strM.t), fmt(i.strF.c,i.strF.t)
        ]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s2), "å„é¡¹ç›®ä¼˜è‰¯ç‡");

    // Sheet 3
    const s3 = [['ç­çº§','æ€»æ•°','ä¼˜è‰¯ç‡','åŠæ ¼ç‡','ä¸åŠæ ¼']];
    Object.keys(classStats).sort().forEach(c => {
        const s = classStats[c];
        s3.push([c, s.tot, fmt(s.exc+s.good,s.tot), fmt(s.tot-s.fail,s.tot), fmt(s.fail,s.tot)]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(s3), "ç­çº§è¯¦æƒ…");

    XLSX.writeFile(wb, 'ä½“æµ‹åˆ†ææŠ¥å‘Š.xlsx');
}

const s2g = (s) => {
    if(s === '-' || s === 0 || s === '0' || s === '' || s === null) return '';
    if(s>=90) return 'ä¼˜ç§€';
    if(s>=80) return 'è‰¯å¥½';
    if(s>=60) return 'åŠæ ¼';
    return 'ä¸åŠæ ¼';
};

function calculateRowData(d) {
    const grade = normalizeGrade(d.gc);
    const gender = normalizeGender(d.ge);
    const key = getSafeKey(grade, gender);
    const isMale = gender === 'ç”·';

    if (!key) {
        return {
            ...d, grade, gender, isMale,
            res: { bmiS:'-', bmiL:'-', sLung:'-', s50:'-', sSit:'-', sJump:'-', sStr:'-', sRun:'-', bonus:'0', total:'0', g:'æ ‡å‡†ç¼ºå¤±', err: true }
        };
    }

    let bmiS = 0, bmiL = '';
    if(d.h && d.w) {
        const bmi = d.w / ((d.h/100)**2);
        const lim = STDS.bmi[key];
        if(lim) {
            if(bmi <= lim[0]) { bmiL='ä½ä½“é‡'; bmiS=80; }
            else if(bmi <= lim[1]) { bmiL='æ­£å¸¸'; bmiS=100; }
            else if(bmi <= lim[2]) { bmiL='è¶…é‡'; bmiS=80; }
            else { bmiL='è‚¥èƒ–'; bmiS=60; }
        }
    }

    const realGetScore = (val, table, mode) => {
        if(val==='' || val===null || isNaN(val)) return 0;
        val = parseFloat(val);
        if(!table) return 0;
        for(let i=0; i<table.length; i++) {
            const [lim, sc] = table[i];
            if((mode===1 && val >= lim) || (mode===-1 && val <= lim)) return sc;
        }
        const last = table[table.length-1];
        return last[1] > 10 ? last[1]-10 : 10;
    };

    const getBonus = (val, table, rule, mode) => {
        if(!val || !table || !rule) return 0;
        const maxStd = table[0][0];
        let b = 0;
        if(mode === 1 && val > maxStd) b = Math.floor((val - maxStd) / rule.base);
        if(mode === -1 && val < maxStd) b = Math.floor((maxStd - val) / rule.base);
        return Math.min(rule.limit, Math.max(0, b)); 
    };

    const sLung = realGetScore(d.lung, STDS.lung[key], 1);
    const s50 = realGetScore(d.r50, STDS.run50[key], -1);
    const sSit = realGetScore(d.sit, STDS.sit[key], 1);
    const sJump = realGetScore(d.jump, STDS.jump[key], 1);

    let sStr=0, sRun=0, bStr=0, bRun=0;
    if(isMale) {
        sStr = realGetScore(d.pull, STDS.str[key], 1);
        if(sStr===100) bStr = getBonus(d.pull, STDS.str[key], STDS.bonusRule.str["ç”·"], 1);
        
        const tRun = parseTime(d.r1000);
        sRun = tRun > 0 ? realGetScore(tRun, STDS.runL[key], -1) : 0;
        if(sRun===100) bRun = getBonus(tRun, STDS.runL[key], STDS.bonusRule.run["ç”·"], -1);
    } else {
        sStr = realGetScore(d.situp, STDS.str[key], 1);
        if(sStr===100) bStr = getBonus(d.situp, STDS.str[key], STDS.bonusRule.str["å¥³"], 1);
        
        const tRun = parseTime(d.r800);
        sRun = tRun > 0 ? realGetScore(tRun, STDS.runL[key], -1) : 0;
        if(sRun===100) bRun = getBonus(tRun, STDS.runL[key], STDS.bonusRule.run["å¥³"], -1);
    }

    const W = STDS.weights;
    const baseScore = bmiS*W.bmi + sLung*W.lung + s50*W.run50 + sJump*W.jump + sSit*W.sit + sStr*W.str + sRun*W.runL;
    const bonusScore = Math.min(20, bStr + bRun); 
    const total = (baseScore + bonusScore).toFixed(1);
    
    let g = 'ä¸åŠæ ¼';
    if(total>=90) g='ä¼˜ç§€'; else if(total>=80) g='è‰¯å¥½'; else if(total>=60) g='åŠæ ¼';

    return { 
        ...d, grade, gender, isMale, 
        res: { bmiS, bmiL, sLung, s50, sSit, sJump, sStr, sRun, bonus: bonusScore, total, g, err: false } 
    };
}

function updateUniqueClasses() {
    const classes = new Set(GLOBAL_DATA.map(d => d.gc || 'æœªåˆ†ç±»'));
    UNIQUE_CLASSES = Array.from(classes).sort();
    if (CUR_CLASS_IDX >= UNIQUE_CLASSES.length) CUR_CLASS_IDX = 0;
}

function renderTable() {
    const tbody = document.getElementById('tableBody');
    if (GLOBAL_DATA.length === 0) {
        tbody.innerHTML = '';
        document.getElementById('page-info').innerText = 'æš‚æ— æ•°æ®';
        return;
    }

    updateUniqueClasses();
    const curClass = UNIQUE_CLASSES[CUR_CLASS_IDX];
    const pageData = GLOBAL_DATA.map((d, i) => ({...d, realIdx: i})).filter(d => (d.gc || 'æœªåˆ†ç±»') === curClass);

    document.getElementById('page-info').innerText = `å½“å‰ï¼š${curClass} (${CUR_CLASS_IDX + 1}/${UNIQUE_CLASSES.length} ä¸ªç­çº§)`;

    const html = pageData.map(d => {
        const r = d.res;
        const maleDis = d.isMale ? '' : 'disabled style="background:#f9f9f9"';
        const femDis = !d.isMale ? '' : 'disabled style="background:#f9f9f9"';
        
        const cls = (sc) => {
            if (sc === '-') return '';
            return sc>=90?'text-exc':(sc>=80?'text-good':(sc>=60?'text-pass':'text-fail'));
        };
        
        let bmiCls = '';
        if (r.bmiL === '-') bmiCls = '';
        else bmiCls = r.bmiL==='æ­£å¸¸'?'text-bmi-norm':(r.bmiL==='è‚¥èƒ–'?'text-bmi-bad':'text-bmi-warn');
        
        let gCls = '';
        if (r.err) gCls = 'text-error';
        else gCls = r.g==='ä¼˜ç§€'?'text-exc':(r.g==='è‰¯å¥½'?'text-good':(r.g==='åŠæ ¼'?'text-pass':'text-fail'));
        
        return `<tr data-idx="${d.realIdx}">
            <td><input class="cell-input" data-f="gc" value="${d.gc||''}"></td>
            <td><input class="cell-input" data-f="name" value="${d.name||''}"></td>
            <td><input class="cell-input" data-f="ge" value="${d.ge||''}"></td>
            <td><input class="cell-input" type="number" data-f="h" value="${d.h||''}"></td>
            <td><input class="cell-input" type="number" data-f="w" value="${d.w||''}"></td>
            <td><input class="cell-input" type="number" data-f="lung" value="${d.lung||''}"></td>
            <td><input class="cell-input" type="number" data-f="r50" value="${d.r50||''}"></td>
            <td><input class="cell-input" type="number" data-f="sit" value="${d.sit||''}"></td>
            <td><input class="cell-input" type="number" data-f="situp" value="${d.situp||''}" ${femDis}></td>
            <td><input class="cell-input" type="number" data-f="jump" value="${d.jump||''}"></td>
            <td><input class="cell-input" type="number" data-f="pull" value="${d.pull||''}" ${maleDis}></td>
            <td><input class="cell-input" type="number" data-f="r1000" value="${d.r1000||''}" ${maleDis}></td>
            <td><input class="cell-input" type="number" data-f="r800" value="${d.r800||''}" ${femDis}></td>
            
            <td class="calc-cell bg-header-score" title="BMIå¾—åˆ†">${r.bmiS}</td>
            <td class="bg-header-score ${bmiCls}">${r.bmiL}</td>
            
            <td class="calc-cell bg-header-score">${r.sLung}</td>
            <td class="bg-header-score ${cls(r.sLung)}">${s2g(r.sLung)}</td>
            
            <td class="calc-cell bg-header-score">${r.s50}</td>
            <td class="bg-header-score ${cls(r.s50)}">${s2g(r.s50)}</td>
            
            <td class="calc-cell bg-header-score">${r.sJump}</td>
            <td class="bg-header-score ${cls(r.sJump)}">${s2g(r.sJump)}</td>
            
            <td class="calc-cell bg-header-score">${r.sSit}</td>
            <td class="bg-header-score ${cls(r.sSit)}">${s2g(r.sSit)}</td>
            
            <td class="calc-cell bg-header-score">${d.isMale?'-':r.sRun}</td>
            <td class="bg-header-score ${!d.isMale?cls(r.sRun):''}">${d.isMale?'':s2g(r.sRun)}</td>
            
            <td class="calc-cell bg-header-score">${d.isMale?r.sRun:'-'}</td>
            <td class="bg-header-score ${d.isMale?cls(r.sRun):''}">${d.isMale?s2g(r.sRun):''}</td>
            
            <td class="calc-cell bg-header-score">${d.isMale?'-':r.sStr}</td>
            <td class="bg-header-score ${!d.isMale?cls(r.sStr):''}">${d.isMale?'':s2g(r.sStr)}</td>
            
            <td class="calc-cell bg-header-score">${d.isMale?r.sStr:'-'}</td>
            <td class="bg-header-score ${d.isMale?cls(r.sStr):''}">${d.isMale?s2g(r.sStr):''}</td>
            
            <td class="bg-header-score">${r.bonus}</td>
            <td class="text-total bg-header-score">${r.total}</td>
            <td class="bg-header-score ${gCls}">${r.g}</td>
            <td><button class="btn btn-red" onclick="delRow(${d.realIdx})" style="padding:2px 6px">Ã—</button></td>
        </tr>`;
    }).join('');

    tbody.innerHTML = html;
}

function changeClass(delta) {
    if (UNIQUE_CLASSES.length === 0) return;
    CUR_CLASS_IDX += delta;
    if (CUR_CLASS_IDX < 0) CUR_CLASS_IDX = UNIQUE_CLASSES.length - 1;
    if (CUR_CLASS_IDX >= UNIQUE_CLASSES.length) CUR_CLASS_IDX = 0;
    renderTable();
}

document.getElementById('tableBody').addEventListener('input', function(e) {
    if(e.target.tagName === 'INPUT') {
        const tr = e.target.closest('tr');
        const idx = parseInt(tr.dataset.idx);
        const field = e.target.dataset.f;
        GLOBAL_DATA[idx][field] = e.target.value;
        GLOBAL_DATA[idx] = calculateRowData(GLOBAL_DATA[idx]);
        
        const d = GLOBAL_DATA[idx];
        const r = d.res;
        const cells = tr.children;

        cells[13].innerText = r.bmiS; cells[14].innerText = r.bmiL;
        cells[15].innerText = r.sLung; cells[16].innerText = s2g(r.sLung);
        cells[17].innerText = r.s50; cells[18].innerText = s2g(r.s50);
        cells[19].innerText = r.sJump; cells[20].innerText = s2g(r.sJump);
        cells[21].innerText = r.sSit; cells[22].innerText = s2g(r.sSit);
        
        cells[23].innerText = d.isMale?'-':r.sRun; cells[24].innerText = d.isMale?'':s2g(r.sRun);
        cells[25].innerText = d.isMale?r.sRun:'-'; cells[26].innerText = d.isMale?s2g(r.sRun):'';
        cells[27].innerText = d.isMale?'-':r.sStr; cells[28].innerText = d.isMale?'':s2g(r.sStr);
        cells[29].innerText = d.isMale?r.sStr:'-'; cells[30].innerText = d.isMale?s2g(r.sStr):'';
        
        cells[31].innerText = r.bonus;
        cells[32].innerText = r.total;
        cells[33].innerText = r.g;
        
        saveData(); // è‡ªåŠ¨ä¿å­˜
    }
});

function addNewRow() {
    const defaultClass = UNIQUE_CLASSES.length > 0 ? UNIQUE_CLASSES[CUR_CLASS_IDX] : 'åˆä¸€1ç­';
    GLOBAL_DATA.push(calculateRowData({ gc: defaultClass, ge:'1' }));
    renderTable();
    saveData();
}

function delRow(idx) {
    if(confirm('åˆ é™¤æ­¤è¡Œ?')) { GLOBAL_DATA.splice(idx, 1); renderTable(); saveData(); }
}

function clearTable() {
    if(confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®? (æ­¤æ“ä½œä¸å¯æ¢å¤)')) { 
        GLOBAL_DATA = []; 
        UNIQUE_CLASSES = []; 
        CUR_CLASS_IDX = 0; 
        renderTable(); 
        localStorage.removeItem(STORAGE_KEY);
    }
}

function importExcel(e) {
    const f = e.target.files[0];
    const r = new FileReader();
    r.onload = function(ev) {
        const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
        if(json.length<2) return;
        const h = json[0].map(s=>String(s).trim());
        const idx = k => h.findIndex(s => s.includes(k));
        let gcIdx = idx('ç­çº§'); if(gcIdx===-1) gcIdx=idx('å¹´çº§');
        const col = { gc: gcIdx, ge: idx('æ€§åˆ«'), na: idx('å§“å'), ht: idx('èº«é«˜'), wt: idx('ä½“é‡'), lu: idx('è‚ºæ´»é‡'), r50: idx('50ç±³'), st: idx('åä½'), jp: idx('è·³è¿œ'), strM: idx('å¼•ä½“'), strF: idx('ä»°å§'), runM: idx('1000'), runF: idx('800') };

        const newData = [];
        for(let i=1; i<json.length; i++) {
            const r = json[i];
            if(!r.length) continue;
            newData.push(calculateRowData({
                gc: col.gc>-1?r[col.gc]:'åˆä¸€1ç­', name: col.na>-1?r[col.na]:'', ge: col.ge>-1?r[col.ge]:'1',
                h: col.ht>-1?r[col.ht]:'', w: col.wt>-1?r[col.wt]:'', lung: col.lu>-1?r[col.lu]:'', r50: col.r50>-1?r[col.r50]:'',
                sit: col.st>-1?r[col.st]:'', jump: col.jp>-1?r[col.jp]:'',
                situp: col.strF>-1?r[col.strF]:'', pull: col.strM>-1?r[col.strM]:'',
                r1000: col.runM>-1?r[col.runM]:'', r800: col.runF>-1?r[col.runF]:''
            }));
        }
        GLOBAL_DATA = newData;
        updateUniqueClasses();
        CUR_CLASS_IDX = 0;
        renderTable();
        saveData();
        alert(`æˆåŠŸå¯¼å…¥ ${newData.length} æ¡æ•°æ®ï¼`);
    };
    r.readAsArrayBuffer(f);
}

function exportToExcel() {
    const header = ["ç­çº§","å§“å","æ€§åˆ«","èº«é«˜","ä½“é‡","è‚ºæ´»é‡","50ç±³","åä½","ä»°å§","è·³è¿œ","å¼•ä½“","1000ç±³","800ç±³","æ€»åˆ†","ç­‰çº§"];
    const body = GLOBAL_DATA.map(d => [d.gc, d.name, d.ge, d.h, d.w, d.lung, d.r50, d.sit, d.situp, d.jump, d.pull, d.r1000, d.r800, d.res.total, d.res.g]);
    const ws = XLSX.utils.aoa_to_sheet([header, ...body]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "æ•°æ®");
    XLSX.writeFile(wb, 'ä½“æµ‹æ•°æ®.xlsx');
}

function switchView(v) {
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-'+v).classList.add('active');
    document.getElementById('view-data').style.display = v==='data'?'block':'none';
    document.getElementById('view-report').style.display = v==='report'?'block':'none';
    document.querySelector('.pagination').style.display = v==='data'?'flex':'none'; 
    if(v==='report') genReport();
}

// åˆå§‹åŒ–å­è¡¨å¤´
let sh = ''; 
for(let i=0; i<9; i++) sh += '<th class="bg-header-score col-w-xs">å¾—åˆ†</th><th class="bg-header-score col-w-xs">ç­‰çº§</th>';
document.getElementById('subHeader').innerHTML = sh;

// åˆå§‹åŒ–åº”ç”¨
function initApp() {
    // 1. æ£€æŸ¥Session
    if (sessionStorage.getItem(AUTH_CONFIG.sessionKey) === 'true') {
        unlockApp();
    }
    // 2. åŠ è½½æ•°æ®
    if (!loadData()) {
        addNewRow();
    }
}

initApp();
</script>
</body>
</html>
